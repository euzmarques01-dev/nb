<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Resultados – TSE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;font-family:'Roboto',sans-serif}
body{margin:0;background:#f2f4f7;color:#111}
header{background:#0b5ed7;color:white;padding:14px 18px;display:flex;align-items:center;font-size:18px}
header img{height:32px;margin-right:10px}
header button{margin-left:auto;background:white;color:#0b5ed7;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}
#geral,#admin{background:white;margin:12px;border-radius:10px;padding:16px}
.resumo{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
.box{border:1px solid #ddd;border-radius:8px;padding:10px;font-family:'Roboto',sans-serif}
.candidato{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid #eee;align-items:center;font-family:'Roboto',sans-serif}
.candidato img{width:42px;height:42px;border-radius:50%;object-fit:cover;cursor:pointer}
.tag{display:inline-block;padding:2px 8px;font-size:11px;border-radius:6px;margin-left:6px;font-weight:700}
.eleito{background:#0d6efd;color:white;animation:pulse 1s infinite}
.segundo{background:#ffc107;color:black;animation:pulse 1s infinite}
@keyframes pulse{0%{opacity:0.6}50%{opacity:1}100%{opacity:0.6}}
.barra{height:10px;background:#e9ecef;border-radius:6px;margin-top:6px;overflow:hidden}
.barra span{display:block;height:100%;width:0%;background:#0b5ed7;transition:.3s}
.estado{background:#e0e0e0;border:1px solid #ccc;border-radius:8px;padding:12px 6px;text-align:center;cursor:pointer;transition:.3s;font-family:'Roboto',sans-serif;text-transform:uppercase}
.estado small{display:block;font-size:12px}
#estados{margin:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;justify-content:center;align-items:flex-end}
.modalBox{background:white;width:100%;max-height:90vh;overflow:auto;border-radius:12px 12px 0 0;padding:16px}
#admin{display:none;border-top:4px solid #0b5ed7}
#admin input,#admin select{width:100%;padding:8px;margin:6px 0}
#admin button{background:#0b5ed7;color:white;border:none;padding:10px;border-radius:6px;width:100%;cursor:pointer}
.adminCand{border:1px solid #ddd;border-radius:8px;padding:10px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.adminCand .acoes{display:flex;gap:4px;width:100%;flex-wrap:wrap}
.adminCand .eleitoBtn{background:#0d6efd;color:white;padding:6px;border:none;border-radius:6px;flex:1;cursor:pointer}
.adminCand .segundoBtn{background:#ffc107;color:black;padding:6px;border:none;border-radius:6px;flex:1;cursor:pointer}
.adminCand .removerBtn{background:#dc3545;color:white;padding:6px;border:none;border-radius:6px;flex:1;cursor:pointer}
#painelStatusRapido div{margin-bottom:6px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
#painelStatusRapido button{padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-weight:700}
h4.cargoTitle{margin:10px 0 4px 0;font-size:14px;color:#333;font-weight:700;font-family:'Roboto',sans-serif;text-transform:uppercase}
</style>
</head>
<body>

<header>
  <img src="https://www.estudotop.com.br/wp-content/uploads/elementor/thumbs/logo-tse-unificado_3-q05569dfkxnbyd38wsipr6u6y7klwz2ncpfpehoub2.png">
  TRIBUNAL SUPERIOR ELEITORAL – TSE
  <button onclick="login()">NAÇÃO BRASILEIRA</button>
</header>

<div id="geral">
<h2>Apuração Nacional</h2>
<div class="barra"><span id="barraGeral"></span></div>
<p><strong>Urnas:</strong> <span id="gUrnas">0%</span></p>
<div class="resumo">
  <div class="box"><span>Total votos:  </span><strong id="gTotal">0</strong></div>
  <div class="box"><span>Brancos:  </span><strong id="gBrancos">0</strong></div>
  <div class="box"><span>Nulos:  </span><strong id="gNulos">0</strong></div>
</div>
<h3>Presidente</h3>
<div id="presidenteNacional"></div>
</div>

<div id="estados"></div>

<div class="modal" id="modal">
  <div class="modalBox">
    <h2 id="tituloEstado"></h2>
    <p><strong>Urnas:</strong> <span id="eUrnas"></span>%</p>
    <div class="barra"><span id="barraEstado"></span></div>
    <p><strong>Brancos:</strong> <span id="eBrancos"></span></p>
    <p><strong>Nulos:</strong> <span id="eNulos"></span></p>
    <div id="listaCandidatos"></div>
    <button onclick="fechar()">Fechar</button>
  </div>
</div>

<div id="admin">
<h2>Painel do Fundador</h2>
<select id="admEstado"></select>
<label>Cor da UF</label>
<input type="color" id="admCor" value="#0b5ed7">
<button onclick="definirCor()">Definir cor do estado</button>
<hr>

<hr>
<select id="admCargo">
  <option>presidente</option>
  <option>governador</option>
  <option>senador</option>
  <option>deputado</option>
</select>
<input id="admNome" placeholder="Nome">
<input id="admPartido" placeholder="Partido">
<button onclick="abrirGaleriaFoto()">Escolher Foto</button>
<input type="hidden" id="admFoto">
<input type="number" id="admVotos" placeholder="Votos">
<button onclick="criarCandidato()">Criar candidato</button>

<hr>
<input type="number" id="admUrnas" placeholder="% Urnas">
<input type="number" id="admBrancos" placeholder="Brancos">
<input type="number" id="admNulos" placeholder="Nulos">

<h3>Controle de % de Urnas por Estado</h3>
<select id="admEstadoSlider" onchange="atualizarSliderEstado()"></select>
<input type="range" id="sliderUrnas" min="0" max="100" value="0" oninput="atualizarSlider(this.value)">
<span id="valorSlider">0%</span>

<hr>
<h3>Status Rápido – Presidente Nacional</h3>
<p>Marque um candidato como ELEITO ou 2º TURNO diretamente no painel geral:</p>
<div id="painelStatusRapido"></div>
<button onclick="atualizarPainelStatus()">Atualizar Lista</button>

<hr>
<h3 style="color:red">Apagar Candidatos</h3>
<label>Selecione o cargo que deseja apagar:</label>
<select id="admCargoApagar">
  <option value="presidente">Presidente</option>
  <option value="governador">Governador</option>
  <option value="senador">Senador</option>
  <option value="deputado">Deputado</option>
</select>

<script type="module">
import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const db = getDatabase();
const estados = ["AC","AL","AP","AM","BA","CE","DF","ES","GO","MA","MT","MS","MG","PA","PB","PR","PE","PI","RJ","RN","RS","RO","RR","SC","SP","SE","TO","EXTERIOR"];

  for (const uf of estados) {
    const candidatosRef = ref(db, `estados/${uf}/candidatos`);
    const snap = await get(candidatosRef);

    if (snap.exists()) {
      const candidatos = snap.val();
      // percorre cada candidato
      for (const key in candidatos) {
        if (candidatos[key].cargo === cargo) {
          // Remove o candidato corretamente
          await remove(ref(db, `estados/${uf}/candidatos/${key}`));
          console.log(`Removido: ${candidatos[key].nome} (${cargo}) do estado ${uf}`);
        }
      }
    }
  }

  alert(`Todos os candidatos do cargo "${cargo}" foram apagados com sucesso!`);
});

</script>
window.login = function(){ 
  if(prompt("Senha do fundador")==senha){ 
    admin.style.display="block"; 
    atualizarListaAdmin(); 
    atualizarPainelStatus();
    atualizarSliderEstado();

    // Botão Apagar Candidatos
    const btnApagar = document.getElementById("btnApagar");
    btnApagar.addEventListener("click", async () => {
      const cargo = document.getElementById("admCargoApagar").value;
      if (!confirm(`Deseja apagar TODOS os candidatos do cargo "${cargo}"?`)) return;

      for (const uf of estados) {
        const candidatosRef = ref(db, `estados/${uf}/candidatos`);
        const snap = await get(candidatosRef);

        if (snap.exists()) {
          const candidatos = snap.val();
          for (const key in candidatos) {
            if (candidatos[key].cargo === cargo) {
              await remove(ref(db, `estados/${uf}/candidatos/${key}`));
            }
          }
        }
      }
      alert(`Todos os candidatos do cargo "${cargo}" foram apagados com sucesso!`);
    });
window.login = function(){ 
  if(prompt("Senha do fundador")==senha){ 
    admin.style.display="block"; 
    atualizarListaAdmin(); 
    atualizarPainelStatus();
    atualizarSliderEstado();

    // --- Botão Apagar Candidatos ---
    const btnApagar = document.getElementById("btnApagar");
    btnApagar.addEventListener("click", async () => {
      const cargo = document.getElementById("admCargoApagar").value;
      if (!confirm(`Deseja apagar TODOS os candidatos do cargo "${cargo}"?`)) return;

      for (const uf of estados) {
        const candidatosRef = ref(db, `estados/${uf}/candidatos`);
        const snap = await get(candidatosRef);
        if (snap.exists()) {
          const candidatos = snap.val();
          for (const key in candidatos) {
            if (candidatos[key].cargo === cargo) {
              await remove(ref(db, `estados/${uf}/candidatos/${key}`));
            }
          }
        }
      }
      alert(`Todos os candidatos do cargo "${cargo}" foram apagados com sucesso!`);
    });

</div>
<div id="listaAdmin"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
import { getDatabase, ref, set, push, update, onValue, remove, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAE-c6y2Z1JsQplCfj1UNW7Wyr4ssCsJQU",
  authDomain: "tse-painel.firebaseapp.com",
  databaseURL: "https://tse-painel-default-rtdb.firebaseio.com",
  projectId: "tse-painel",
  storageBucket: "tse-painel.firebasestorage.app",
  messagingSenderId: "818733405394",
  appId: "1:818733405394:web:8e3e3e45062e3122e9490b",
  measurementId: "G-49XLVVE7D5"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);

const senha="2007";
const avatar="https://via.placeholder.com/100?text=Foto";
const estados=["AC","AL","AP","AM","BA","CE","DF","ES","GO","MA","MT","MS","MG","PA","PB","PR","PE","PI","RJ","RN","RS","RO","RR","SC","SP","SE","TO","EXTERIOR"];

const estadosDiv=document.getElementById("estados");
const sel=document.getElementById("admEstado");
const selSlider=document.getElementById("admEstadoSlider");
const slider=document.getElementById("sliderUrnas");
const valorSlider=document.getElementById("valorSlider");

let overrideGeralUrnas = null;
let galeriaFotoSelecionada = avatar;

// Função para formatar números com separador de milhar
function formatNumber(num){
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Inicializa estados no DB se não existir e cria dropdowns
estados.forEach(e=>{
  const estadoRef = ref(db,'estados/'+e);
  get(estadoRef).then(snap=>{
    if(!snap.exists()){
      set(estadoRef,{ urnas:0, brancos:0, nulos:0, cor:"#e0e0e0", candidatos:{} });
    }
  });
  estadosDiv.innerHTML+=`<div class="estado" id="uf-${e}" onclick="abrir('${e}')">${e}<small>0%</small></div>`;
  sel.innerHTML+=`<option>${e}</option>`;
  selSlider.innerHTML+=`<option>${e}</option>`;
});

// Login do fundador
window.login = function(){ 
  if(prompt("Senha do fundador")==senha){ 
    admin.style.display="block"; 
    atualizarListaAdmin(); 
    atualizarPainelStatus();
    atualizarSliderEstado();
  } 
}

// Definir cor do estado
window.definirCor = function(){
  const estado = sel.value;
  const cor = document.getElementById("admCor").value;
  update(ref(db,'estados/'+estado), { cor: cor });
}

// Abrir galeria de fotos (real)
window.abrirGaleriaFoto = function(){
  let input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";

  input.onchange = () => {
    const file = input.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      galeriaFotoSelecionada = e.target.result; // base64
    };
    reader.readAsDataURL(file);
  };

  input.click(); // abre a galeria
}

// Criar candidato
window.criarCandidato = async function(){
  if(!admNome.value || !admPartido.value) return alert("Preencha nome e partido");
  const novo = {
    nome: admNome.value,
    partido: admPartido.value,
    cargo: admCargo.value,
    votos: Number(admVotos.value)||0,
    foto: galeriaFotoSelecionada || avatar,
    status: ""
  };

  if(admCargo.value==="presidente"){
    for(const uf of estados){
      const cRef = push(ref(db,'estados/'+uf+'/candidatos'));
      await set(cRef, novo);
    }
  } else {
    const cRef = push(ref(db,'estados/'+sel.value+'/candidatos'));
    await set(cRef, novo);
  }

  atualizarListaAdmin();
  atualizarPainelStatus();
}

// Atualizar estado
window.atualizarEstado = function(){
  const estado = sel.value;
  update(ref(db,'estados/'+estado),{
    urnas:Number(admUrnas.value)||0,
    brancos:Number(admBrancos.value)||0,
    nulos:Number(admNulos.value)||0
  });
}

// Slider
window.atualizarSliderEstado = function(){
  const estado = selSlider.value;
  get(ref(db,'estados/'+estado)).then(snap=>{
    const d = snap.val();
    slider.value = d.urnas;
    valorSlider.textContent = d.urnas + "%";
  });
}
window.atualizarSlider = function(valor){
  valorSlider.textContent = valor + "%";
  const estado = selSlider.value;
  update(ref(db,'estados/'+estado), { urnas:Number(valor) });
}

// Atualização em tempo real dos estados
estados.forEach(uf=>{
  onValue(ref(db,'estados/'+uf), snap=>{
    const d = snap.val();
    const div = document.getElementById("uf-"+uf);
    div.style.background = d.cor;
    div.innerHTML = `${uf}<small>${d.urnas}%</small>`;
    atualizarGeral();
    if(modal.style.display==="flex" && tituloEstado.textContent===uf) abrir(uf);
  });
});

// Lista admin
function atualizarListaAdmin(){
  listaAdmin.innerHTML = "";
  estados.forEach(uf => {
    const estadoRef = ref(db, `estados/${uf}/candidatos`);
    get(estadoRef).then(snap => {
      const cData = snap.val()||{};
      Object.entries(cData).forEach(([key,c])=>{
        const div = document.createElement("div");
        div.className="adminCand";
        div.innerHTML=`
          <img src="${c.foto||avatar}" width="42" height="42">
          <div>
          <strong>${c.nome}</strong> (${c.partido}) – ${uf}<br>
          <input type="number" value="${c.votos}">
          <div class="acoes">
            <button class="eleitoBtn">ELEITO</button>
            <button class="segundoBtn">2º TURNO</button>
            <button class="removerBtn">Excluir</button>
          </div>
          </div>
        `;
        div.querySelector("input").addEventListener("change",()=>update(ref(db, `estados/${uf}/candidatos/${key}`), { votos: Number(div.querySelector("input").value) }));
        div.querySelector(".eleitoBtn").addEventListener("click",()=>update(ref(db, `estados/${uf}/candidatos/${key}`), { status: "eleito" }));
        div.querySelector(".segundoBtn").addEventListener("click",()=>update(ref(db, `estados/${uf}/candidatos/${key}`), { status: "segundo" }));
        div.querySelector(".removerBtn").addEventListener("click",()=>{ if(confirm(`Deseja realmente excluir ${c.nome}?`)) remove(ref(db, `estados/${uf}/candidatos/${key}`)).then(()=> div.remove()); });
        listaAdmin.appendChild(div);
      });
    });
  });
}

// Painel rápido
function atualizarPainelStatus(){
  painelStatusRapido.innerHTML="";
  estados.forEach(uf=>{
    get(ref(db, `estados/${uf}/candidatos`)).then(snap=>{
      const cData = snap.val()||{};
      Object.entries(cData).forEach(([key,c])=>{
        if(c.cargo!=="presidente") return;
        const btnContainer = document.createElement("div");
        btnContainer.innerHTML=`
          <strong>${c.nome} (${c.partido})</strong> – ${uf}
          <button class="eleitoRapido" style="background:#0d6efd;color:white;">ELEITO</button>
          <button class="segundoRapido" style="background:#ffc107;color:black;">2º TURNO</button>
        `;
        btnContainer.querySelector(".eleitoRapido").addEventListener("click",()=>update(ref(db, `estados/${uf}/candidatos/${key}`), { status:"eleito" }));
        btnContainer.querySelector(".segundoRapido").addEventListener("click",()=>update(ref(db, `estados/${uf}/candidatos/${key}`), { status:"segundo" }));
        painelStatusRapido.appendChild(btnContainer);
      });
    });
  });
}
// Atualizar geral
function atualizarGeral(){
  let total=0, br=0, nu=0;
  let pres={};
  let somaUrnas=0, countUrnas=0;

  estados.forEach(uf=>{
    get(ref(db,'estados/'+uf)).then(snap=>{
      const d = snap.val();
      br+=d.brancos; nu+=d.nulos;
      somaUrnas+=d.urnas; countUrnas++;

      Object.values(d.candidatos||{}).forEach(c=>{
        if(c.cargo==="presidente"){
          pres[c.nome]=pres[c.nome]||{v:0,f:c.foto,p:c.partido,s:c.status};
          pres[c.nome].v+=c.votos;
          pres[c.nome].s=c.status;
          total+=c.votos;
        }
      });

      // Atualiza barra geral e urnas
      barraGeral.style.width = (somaUrnas/countUrnas) + "%";
      gUrnas.textContent = (somaUrnas/countUrnas).toFixed(0)+"%";
      gTotal.textContent = formatNumber(total);
      gBrancos.textContent = formatNumber(br);
      gNulos.textContent = formatNumber(nu);

      // Atualiza candidatos
      presidenteNacional.innerHTML="";
      Object.entries(pres).sort((a,b)=>b[1].v-a[1].v).forEach(([n,c],i)=>{
        let tag="";
        if(c.s==="eleito") tag=`<span class="tag eleito">ELEITO</span>`;
        else if(c.s==="segundo") tag=`<span class="tag segundo">2º TURNO</span>`;
        let perc=(total?((c.v/total)*100).toFixed(1):0);
        presidenteNacional.innerHTML+=`
          <div class="candidato">
            <img src="${c.f}" title="${c.p}">
            <div><strong>${n}</strong> (${c.p}) ${tag}<br>${formatNumber(c.v)} votos – ${perc}%</div>
          </div>
        `;
      });
    });
  });
}

// Abrir modal do estado
window.abrir = function(uf) {
  modal.style.display = "flex";
  tituloEstado.textContent = uf;

  get(ref(db, 'estados/' + uf)).then(snap => {
    const d = snap.val();
    eUrnas.textContent = d.urnas;
    eBrancos.textContent = formatNumber(d.brancos);
    eNulos.textContent = formatNumber(d.nulos);
    barraEstado.style.width = d.urnas + "%";

    listaCandidatos.innerHTML = "";
    let cargos = {};

    Object.values(d.candidatos || {}).forEach(c => {
      cargos[c.cargo] = cargos[c.cargo] || [];
      cargos[c.cargo].push(c);
    });

    const ordemCargos = ["presidente", "governador", "senador", "deputado"];

    ordemCargos.forEach(cargo => {
      if (!cargos[cargo]) return;
      const arr = cargos[cargo];

      listaCandidatos.innerHTML += `<h4 class="cargoTitle">${cargo}</h4>`;
      let totalVotos = arr.reduce((a, b) => a + b.votos, 0);

      arr
        .sort((a, b) => b.votos - a.votos)
        .forEach(c => {
          let tag = "";
          if (c.status === "eleito") tag = `<span class="tag eleito">ELEITO</span>`;
          else if (c.status === "segundo") tag = `<span class="tag segundo">2º TURNO</span>`;

          let perc = totalVotos ? ((c.votos / totalVotos) * 100).toFixed(1) : 0;

          listaCandidatos.innerHTML += `
            <div class="candidato">
              <img src="${c.foto}" title="${c.partido}">
              <div>
                <strong>${c.nome}</strong> (${c.partido}) ${tag}<br>
                ${formatNumber(c.votos)} votos – ${perc}%
              </div>
            </div>
        });
    });
  });
}

window.fechar=function(){ modal.style.display="none" }
</script>

</body>
</html>
