<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Resultados – TSE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;font-family:'Roboto',sans-serif}
body{margin:0;background:#f2f4f7;color:#111}
header{background:#0b5ed7;color:white;padding:14px 18px;display:flex;justify-content:space-between;align-items:center;font-size:18px}
header button{background:white;color:#0b5ed7;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}
#geral,#admin{background:white;margin:12px;border-radius:10px;padding:16px}
.resumo{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
.box{border:1px solid #ddd;border-radius:8px;padding:10px}
.candidato{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid #eee}
.candidato img{width:42px;height:42px;border-radius:50%}
.tag{display:inline-block;padding:2px 8px;font-size:11px;border-radius:6px;margin-left:6px;font-weight:700}
.eleito{background:#0d6efd;color:white;animation:pulse 1s infinite}
.segundo{background:#ffc107;color:#000;animation:pulse 1s infinite}
@keyframes pulse{0%{opacity:0.6}50%{opacity:1}100%{opacity:0.6}}
.barra{height:10px;background:#e9ecef;border-radius:6px;margin-top:6px;overflow:hidden}
.barra span{display:block;height:100%;width:0%;background:#0b5ed7;transition:.3s}
.estado{background:#e0e0e0;border:1px solid #ccc;border-radius:8px;padding:12px 6px;text-align:center;cursor:pointer;transition:.3s}
.estado small{display:block;font-size:12px}
#estados{margin:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;justify-content:center;align-items:flex-end}
.modalBox{background:white;width:100%;max-height:90vh;overflow:auto;border-radius:12px 12px 0 0;padding:16px}
#admin{display:none;border-top:4px solid #0b5ed7}
#admin input,#admin select{width:100%;padding:8px;margin:6px 0}
#admin button{background:#0b5ed7;color:white;border:none;padding:10px;border-radius:6px;width:100%;cursor:pointer}
.adminCand{border:1px solid #ddd;border-radius:8px;padding:10px;margin-bottom:8px}
.adminCand .acoes button{width:100%;margin-top:4px}
.adminCand .eleitoBtn{background:#0d6efd}
.adminCand .segundoBtn{background:#ffc107;color:#000}
.adminCand .removerBtn{background:#dc3545}
</style>
</head>
<body>

<header>
  <img src="https://www.estudotop.com.br/wp-content/uploads/elementor/thumbs/logo-tse-unificado_3-q05569dfkxnbyd38wsipr6u6y7klwz2ncpfpehoub2.png" 
       alt="TRIBUNAL SUPERIOR ELEITORAL" 
       style="width:50px; height:auto; vertical-align:middle; margin-right:10px;">
  TRIBUNAL SUPERIOR ELEITORAL – TSE
  <button onclick="login()">NAÇÃO BRASILEIRA</button>
</header>

<div id="geral">
<h2>Apuração Nacional</h2>
<div class="barra"><span id="barraGeral"></span></div>
<p><strong>Urnas:</strong> <span id="gUrnas">0%</span></p>
<div class="resumo">
  <div class="box"><span>Total votos:  </span><strong id="gTotal">0</strong></div>
  <div class="box"><span>Brancos:  </span><strong id="gBrancos">0</strong></div>
  <div class="box"><span>Nulos:  </span><strong id="gNulos">0</strong></div>
</div>
<h3>Presidente</h3>
<div id="presidenteNacional"></div>
</div>

<div id="estados"></div>

<div class="modal" id="modal">
  <div class="modalBox">
    <h2 id="tituloEstado"></h2>
    <p><strong>Urnas:</strong> <span id="eUrnas"></span>%</p>
    <div class="barra"><span id="barraEstado"></span></div>
    <p><strong>Brancos:</strong> <span id="eBrancos"></span></p>
    <p><strong>Nulos:</strong> <span id="eNulos"></span></p>
    <div id="listaCandidatos"></div>
    <button onclick="fechar()">Fechar</button>
  </div>
</div>

<div id="admin">
<h2>Painel do Fundador</h2>
<select id="admEstado"></select>
<label>Cor da UF</label>
<input type="color" id="admCor" value="#0b5ed7">
<button onclick="definirCor()">Definir cor do estado</button>

<hr>
<select id="admCargo">
  <option>presidente</option>
  <option>governador</option>
  <option>senador</option>
  <option>deputado</option>
</select>
<input id="admNome" placeholder="Nome">
<input id="admPartido" placeholder="Partido">
<input id="admFoto" placeholder="Foto URL">
<input type="number" id="admVotos" placeholder="Votos">
<button onclick="criarCandidato()">Criar candidato</button>

<hr>
<input type="number" id="admUrnas" placeholder="% Urnas">
<input type="number" id="admBrancos" placeholder="Brancos">
<input type="number" id="admNulos" placeholder="Nulos">
<button onclick="atualizarEstado()">Atualizar estado</button>

<hr>
<h3>Controle Geral de Urnas</h3>
<p>Altere o % geral manualmente:</p>
<input type="number" id="admGeralUrnas" placeholder="% Geral" min="0" max="100">
<button onclick="atualizarGeralManual()">Atualizar Geral</button>

<hr>
<div id="listaAdmin"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
import { getDatabase, ref, set, push, update, onValue, remove, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAE-c6y2Z1JsQplCfj1UNW7Wyr4ssCsJQU",
  authDomain: "tse-painel.firebaseapp.com",
  databaseURL: "https://tse-painel-default-rtdb.firebaseio.com",
  projectId: "tse-painel",
  storageBucket: "tse-painel.firebasestorage.app",
  messagingSenderId: "818733405394",
  appId: "1:818733405394:web:8e3e3e45062e3122e9490b",
  measurementId: "G-49XLVVE7D5"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);

const senha="2007";
const avatar="https://via.placeholder.com/100?text=Foto";
const estados=["AC","AL","AP","AM","BA","CE","DF","ES","GO","MA","MT","MS","MG","PA","PB","PR","PE","PI","RJ","RN","RS","RO","RR","SC","SP","SE","TO","EXTERIOR"];

const estadosDiv=document.getElementById("estados");
const sel=document.getElementById("admEstado");

// Inicializa estados no DB se não existir
estados.forEach(e=>{
  const estadoRef = ref(db,'estados/'+e);
  get(estadoRef).then(snap=>{
    if(!snap.exists()){
      set(estadoRef,{ urnas:0, brancos:0, nulos:0, cor:"#e0e0e0", candidatos:{} });
    }
  });
  estadosDiv.innerHTML+=`<div class="estado" id="uf-${e}" onclick="abrir('${e}')">${e}<small>0%</small></div>`;
  sel.innerHTML+=`<option>${e}</option>`;
});

let overrideGeralUrnas = null;

// Funções Admin
window.login = function(){ 
  if(prompt("Senha do fundador")==senha){ 
    admin.style.display="block"; 
    atualizarListaAdmin(); 
  } 
}
window.definirCor = function(){
  const estado = sel.value;
  const cor = document.getElementById("admCor").value;
  update(ref(db,'estados/'+estado), { cor: cor });
}

// Cria candidato
window.criarCandidato = async function(){
  if(!admNome.value || !admPartido.value) return alert("Preencha nome e partido");
  const novo = {
    nome: admNome.value,
    partido: admPartido.value,
    cargo: admCargo.value,
    votos: Number(admVotos.value)||0,
    foto: admFoto.value||avatar,
    status: ""
  };

  if(admCargo.value==="presidente"){
    for(const uf of estados){
      const cRef = push(ref(db,'estados/'+uf+'/candidatos'));
      await set(cRef, novo);
    }
  } else {
    const cRef = push(ref(db,'estados/'+sel.value+'/candidatos'));
    await set(cRef, novo);
  }

  atualizarListaAdmin();
}

// Atualiza estado
window.atualizarEstado = function(){
  const estado = sel.value;
  update(ref(db,'estados/'+estado),{
    urnas:Number(admUrnas.value)||0,
    brancos:Number(admBrancos.value)||0,
    nulos:Number(admNulos.value)||0
  });
}

// Atualização manual geral
window.atualizarGeralManual = function(){
  const valor = Number(document.getElementById("admGeralUrnas").value);
  if(valor<0||valor>100) return alert("Digite um valor entre 0 e 100");
  overrideGeralUrnas = valor;
  gUrnas.textContent = valor + "%";
  barraGeral.style.width = valor + "%";
}

// Atualização em tempo real dos estados
estados.forEach(uf=>{
  onValue(ref(db,'estados/'+uf), snap=>{
    const d = snap.val();
    const div = document.getElementById("uf-"+uf);
    div.style.background = d.cor;
    div.innerHTML = `${uf}<small>${d.urnas}%</small>`;
    atualizarGeral();
    if(modal.style.display==="flex" && tituloEstado.textContent===uf) abrir(uf);
  });
});

// Lista admin
function atualizarListaAdmin(){
  listaAdmin.innerHTML = "";
  estados.forEach(uf => {
    const estadoRef = ref(db, `estados/${uf}/candidatos`);
    get(estadoRef).then(snap => {
      const cData = snap.val()||{};
      Object.entries(cData).forEach(([key,c])=>{
        const div = document.createElement("div");
        div.className = "adminCand";
        div.innerHTML = `
          <strong>${c.nome}</strong> (${c.partido}) – ${uf}<br>
          <input type="number" value="${c.votos}">
          <div class="acoes">
            <button class="eleitoBtn">ELEITO</button>
            <button class="segundoBtn">2º TURNO</button>
            <button class="removerBtn">Excluir</button>
          </div>
        `;
        div.querySelector("input").addEventListener("change",()=>update(ref(db, `estados/${uf}/candidatos/${key}`), { votos: Number(div.querySelector("input").value) }));
        div.querySelector(".eleitoBtn").addEventListener("click",()=>update(ref(db, `estados/${uf}/candidatos/${key}`), { status: "eleito" }));
        div.querySelector(".segundoBtn").addEventListener("click",()=>update(ref(db, `estados/${uf}/candidatos/${key}`), { status: "segundo" }));
        div.querySelector(".removerBtn").addEventListener("click",()=>{ if(confirm(`Deseja realmente excluir ${c.nome}?`)) remove(ref(db, `estados/${uf}/candidatos/${key}`)).then(()=> div.remove()); });
        listaAdmin.appendChild(div);
      });
    });
  });
}

// Atualização geral
function atualizarGeral(){
  let total=0, br=0, nu=0;
  let pres={};
  let somaUrnas=0, countUrnas=0;

  estados.forEach(uf=>{
    get(ref(db,'estados/'+uf)).then(snap=>{
      const d = snap.val();
      br += d.brancos; nu += d.nulos;

      somaUrnas += d.urnas;
      countUrnas++;

      Object.values(d.candidatos||{}).forEach(c=>{
        if(c.cargo==="presidente"){
          pres[c.nome] = pres[c.nome] || {v:0,f:c.foto,p:c.partido,s:c.status};
          pres[c.nome].v += c.votos;
          pres[c.nome].s = c.status;
          total += c.votos;
        }
      });

      gTotal.textContent = total;
      gBrancos.textContent = br;
      gNulos.textContent = nu;

      presidenteNacional.innerHTML="";
      Object.entries(pres).sort((a,b)=>b[1].v-a[1].v).forEach(p=>{
        const perc=((p[1].v/total)*100||0).toFixed(1);
        const tag=p[1].s==="eleito"?'<span class="tag eleito">ELEITO</span>':p[1].s==="segundo"?'<span class="tag segundo">2º TURNO</span>':"";
        presidenteNacional.innerHTML+=`
        <div class="candidato">
          <img src="${p[1].f||avatar}">
          <div>
            <strong>${p[0]}</strong> (${p[1].p}) ${tag}<br>
            ${p[1].v} votos • ${perc}% 
            <div class="barra"><span style="width:${perc}%"></span></div>
          </div>
        </div>`;
      });

      if(overrideGeralUrnas===null){
        const mediaUrnas = (somaUrnas / countUrnas).toFixed(1);
        gUrnas.textContent = mediaUrnas + "%";
        barraGeral.style.width = mediaUrnas + "%";
      }
    });
  });
}

// Modal de estado
window.abrir = function(uf) {
  modal.style.display = "flex";
  tituloEstado.textContent = uf;

  onValue(ref(db,'estados/'+uf), snap => {
    const d = snap.val();
    eUrnas.textContent = d.urnas;
    eBrancos.textContent = d.brancos;
    eNulos.textContent = d.nulos;
    barraEstado.style.width = d.urnas + "%";
    barraEstado.style.background = d.cor;

    listaCandidatos.innerHTML = "";

    // Ordem de cargos
    const ordemCargos = ["presidente", "governador", "senador", "deputado"];

    ordemCargos.forEach(cargo => {
      const candidatosCargo = Object.values(d.candidatos || {}).filter(c => c.cargo === cargo);

      if(candidatosCargo.length === 0) return; // pula se não houver candidatos desse cargo

      // Adicionar título do cargo
      listaCandidatos.innerHTML += `<h3 class="cargo-titulo">${cargo.charAt(0).toUpperCase() + cargo.slice(1)}</h3>`;

      // Total de votos do cargo específico
      const totalVotosCargo = candidatosCargo.reduce((a, b) => a + b.votos, 0) || 1;

      candidatosCargo.forEach(c => {
        const perc = ((c.votos / totalVotosCargo) * 100).toFixed(1);
        const tag = c.status === "eleito" ? '<span class="tag eleito">ELEITO</span>' :
                    c.status === "segundo" ? '<span class="tag segundo">2º TURNO</span>' : "";

        listaCandidatos.innerHTML += `
        <div class="candidato">
          <img src="${c.foto || avatar}">
          <div>
            <strong>${c.nome}</strong> (${c.partido}) ${tag}<br>
            ${c.votos} votos • ${perc}% 
            <div class="barra"><span style="width:${perc}%"></span></div>
          </div>
        </div>`;
      });
    });
  });
}

window.fechar = function(){ modal.style.display="none"; }

</script>
</body>
</html>
